```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>HYBRID MASTER 51 – Premium Fitness</title>
  <meta name="color-scheme" content="dark light">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --black: #0B0B12;
      --deep-black: #09090F;
      --gold: #FFD700;
      --blue: #2EA7FF;
      --blue2: #0055ff;
      --offwhite: #F4F4F8;
      --card-bg: #17171D;
      --card-alt: #20202A;
      --gradient: linear-gradient(135deg, #262449 0%, #131313 100%);
      --gradient-gold: linear-gradient(90deg, #FFD700 0%, #FFF6B7 100%);
      --gradient-blue: linear-gradient(90deg, #2EA7FF 0%, #0055ff 100%);
      --primary: var(--gold);
      --danger: #f85a4f;
      --success: #13E884;
      --shimmer: linear-gradient(100deg, #24243e 20%, #343454 50%, #24243e 80%);
      --font: 'Inter', 'SF Pro', system-ui, Arial, Helvetica, sans-serif;
      --shadow: 0 2px 24px 0 rgba(0,0,0,0.15);
      --safe-top: env(safe-area-inset-top, 16px);
      --safe-bottom: env(safe-area-inset-bottom, 16px);
      --fs1: 18px;
      --fs2: 20px;
      --fs3: 22px;
      --spacing: 20px;
      --radius: 16px;
      --transition: 0.22s cubic-bezier(.6,.16,.39,1);
      --elev1: 0 2px 12px 0 rgba(0,0,0,0.10);
      --elev2: 0 4px 32px 0 rgba(20,20,36,0.16);
      --border: 1.8px solid #1e1e2e;
      --focus: 0 0 0 2px var(--blue);
    }

    body {
      background: var(--gradient);
      color: var(--offwhite);
      font-family: var(--font);
      font-size: var(--fs1);
      line-height: 1.5;
      margin: 0;
      padding: 0;
      min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    [hidden], .hidden { display: none !important; }
    header {
      width: 100%;
      background: var(--deep-black);
      padding: calc(var(--safe-top) + 12px) var(--spacing) 18px var(--spacing);
      display: flex; flex-direction: column; align-items: flex-start;
      border-bottom: var(--border);
      box-shadow: var(--elev1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .premium-badge {
      display: inline-flex; gap: 0.25em;
      background: var(--gradient-gold);
      color: var(--deep-black);
      font-weight: 800;
      line-height: 1;
      font-size: 16px; letter-spacing: 0.05em;
      border-radius: 1em;
      padding: 4px 16px;
      margin-bottom: 8px;
    }
    .tile-brand {
      background: var(--gradient-blue);
      border-radius: var(--radius);
      padding: 18px 24px 18px 24px;
      margin-bottom: 12px;
      color: #fff;
      display: flex; align-items: center; gap: 20px;
      box-shadow: var(--elev2);
      font-size: var(--fs3);
      font-weight: 800;
      letter-spacing: 0.02em;
      user-select: none;
      font-family: var(--font);
    }
    .tile-brand svg {
      width: 44px; height: 44px; flex-shrink: 0;
      filter: drop-shadow(0 1px 4px #008cff70);
    }
    .header-desc {
      font-size: 16px;
      color: #e1e1e7;
      line-height: 1.3;
      margin-top: 5px;
      margin-left: 2px;
      margin-bottom: 0px;
      max-width: 430px;
    }
    main {
      width: 100%;
      max-width: 520px;
      margin: auto;
      padding: 0 var(--spacing) calc(var(--safe-bottom) + 22px) var(--spacing);
    }
    section {
      margin: 0 0 22px 0;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--elev1);
      padding: 18px 16px 14px 16px;
      animation: fadeIn .7s var(--transition) both;
    }
    @keyframes fadeIn { from {opacity:0;transform:translateY(20px);} to{opacity:1;transform:none;} }
    .section-title {
      font-size: var(--fs2);
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: 0.01em;
      color: var(--gold);
      line-height: 1.2;
    }
    .block-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--blue);
    }
    .bold { font-weight: 700; }
    .gradient-text {
      background: var(--gradient-gold);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .button, button, .btn {
      all: unset;
      display: inline-block;
      background: var(--gradient-blue);
      color: #fff;
      font-weight: 700;
      font-family: var(--font);
      font-size: 18px;
      border-radius: 28px;
      padding: 12px 30px;
      box-shadow: var(--elev1);
      margin-right: 12px;
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.14s;
      border: none;
      user-select: none;
      position: relative;
    }
    .button:active, .btn:active { filter: brightness(1.15); }
    .button.secondary, .btn.secondary {
      background: var(--deep-black);
      color: var(--gold);
      box-shadow: none; border: var(--border);
    }
    .button.danger { background: var(--danger); color: #fff;}
    .button.success { background: var(--success); color: #111;}
    .button.gold { background: var(--gradient-gold); color: var(--deep-black);}
    .button:focus { outline: var(--focus);}
    .button[aria-pressed="true"], .button.selected { box-shadow: 0 0 0 4px var(--blue); }
    .icon-btn {
      background: transparent !important;
      padding: 7px;
      margin: 0 4px 0 0;
      border-radius: 50%;
      border: var(--border);
      display: inline-flex; align-items: center; justify-content: center;
      line-height: 1;
      width: 40px;
      height: 40px;
      color: var(--gold);
    }
    .icon-btn:active { background: var(--card-alt);}
    input, select, textarea {
      font-size: 18px;
      padding: 8px 12px;
      border-radius: 8px;
      border: var(--border);
      background: var(--card-alt);
      color: #ffffff;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.18s;
      font-family: var(--font);
    }
    input:focus, select:focus, textarea:focus { outline: var(--focus);}
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 7px;
      margin-left: 2px;
      color: var(--primary);
    }
    .week-day-selector {
      display: flex;
      margin-bottom: 16px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .week-btn {
      padding: 7px 14px;
      border-radius: 22px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      outline: none;
      background: var(--card-alt);
      color: #fff;
      cursor: pointer;
      margin-right: 5px;
      transition: background .18s, color .09s, box-shadow .17s;
      box-shadow: none;
    }
    .week-btn.selected, .day-btn.selected {
      background: var(--gold);
      color: var(--deep-black);
      box-shadow: 0 0 0 2px var(--blue);
    }
    .day-selector {
      display: flex; gap:8px; margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .day-btn {
      background: var(--gradient-gold);
      color: var(--deep-black);
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      padding: 7px 14px;
      cursor: pointer;
      margin-right: 0;
      margin-bottom: 4px;
      transition: background .16s, color .08s;
      box-shadow: var(--shadow);
    }
    .tracker-form {
      margin: 0 0 14px 0; display: flex; flex-direction: column; gap: 12px;
    }
    .series-list {
      display: flex; flex-direction: column; gap: 6px; margin: 7px 0 0 0;
    }
    .series-row {
      display: flex; gap: 8px; align-items: center;
      font-size: 18px;
      border-radius: 8px;
      background: var(--card-alt);
      padding: 5px 8px;
      animation: fadeIn .34s var(--transition) both;
    }
    .series-row.completed { border-left: 4px solid var(--success);}
    .series-row input[type="number"] { max-width: 70px; }
    .series-row input[type="text"] { max-width: 120px; }
    .series-row .icon-btn {margin: 0 0 0 8px;}
    .completed {
      color: var(--success);
    }
    .deload {
      background: repeating-linear-gradient(120deg, #FFD70022 0 8px, transparent 8px 16px);
    }
    .block-technical {
      background: repeating-linear-gradient(105deg, #13E88414 0 12px, transparent 11px 24px);
      border-left: 4px solid var(--success);
    }
    .shimmer {
      background: var(--shimmer);
      background-size: 120% 120%;
      animation: shimmerMove 1.05s linear infinite;
      color: transparent;
      border-radius: 12px;
      margin: 0 0 8px 0;
      min-height: 20px;
    }
    @keyframes shimmerMove {
      0% {
        background-position: -20% 0;
      }
      100% {
        background-position: 120% 0;
      }
    }
    .feedback {
      font-size: 16px;
      margin: 8px 0 0 0;
      color: var(--primary);
      min-height: 22px;
    }
    .feedback.danger { color: var(--danger);}
    .feedback.success { color: var(--success);}
    .journal {
      background: var(--card-bg);
      font-size: 15.2px;
      color: #AEE2FF;
      border-radius: var(--radius);
      padding: 12px;
      white-space: pre-wrap;
      max-height: 250px;
      overflow-y: scroll;
      margin: 0 0 8px 0;
      font-family: var(--font), monospace;
    }
    .markdown-report-area {
      font-family: var(--font), monospace;
      border-radius: 12px;
      background: var(--deep-black);
      padding: 15px 16px;
      min-height: 100px;
      margin-bottom: 12px;
      font-size: 15px;
      line-height: 1.3;
      color: #FFEEBA;
      box-shadow: var(--elev2);
      outline: none;
      width: 100%;
      resize: vertical;
    }
    .stat-cards {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .stat-card {
      flex: 1;
      background: var(--card-alt);
      border-radius: 14px;
      box-shadow: var(--elev1);
      padding: 15px 12px 12px 12px;
      min-width: 120px;
      display:flex; flex-direction:column; align-items: center;
      font-size: 17px;
    }
    .stat-card .icon {
      font-size: 28px; margin-bottom: 5px; color: var(--primary);
    }
    .chart-block {
      background: var(--deep-black);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--elev2);
      margin: 0 0 18px 0;
    }
    .charts-container {
      display: flex; flex-direction: column; gap: 20px;
      margin-bottom: 20px;
    }
    .timer-block {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
    }
    .timer-value {
      font-size: 40px;
      font-weight: 700;
      color: var(--primary);
    }
    .focus-modal-bg {
      position: fixed; z-index: 1050;
      inset: 0; background: #000000a0;
      display: flex; align-items: center; justify-content: center;
      opacity: 1; pointer-events: all;
      animation: fadeIn .37s var(--transition) both;
    }
    .focus-modal { background: var(--card-bg); border-radius: 22px; box-shadow: var(--elev2); padding: 38px 34px; max-width: 94vw; font-size: 18px; color: #fff; text-align: center;}
    .modal-btns {margin-top: 18px; display:flex; flex-direction: column; gap: 10px;}
    @media (max-width:600px) {
      .tile-brand { font-size: 21px; }
      .header-desc { font-size: 15px;}
      main { padding: 0 5vw calc(var(--safe-bottom) + 12vw) 5vw;}
      .section-title { font-size: 17px;}
    }
    @media (max-width:395px) {
      .tile-brand { font-size: 16px; }
      .section-title { font-size: 14px;}
      .stat-card { font-size: 14px;}
    }
    @media (min-width:760px) {
      main { max-width: 640px;}
    }
    ::selection { background: #008cff33;}
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    /* Print Markdown report nicely */
    @media print {
      body { background: #fff; color: #111;}
      section, .markdown-report-area, main { background: #fff !important; color: #111;}
      .stat-cards, .premium-badge, .tile-brand, header, .journals-exec, .charts-container, .button, .btn, .week-day-selector, .day-selector, nav, .timer-block { display: none !important;}
      .markdown-report-area { color: #111; border: none;}
    }
    /* Scrollbar minimal */
    ::-webkit-scrollbar { width: 8px; background: #191929; border-radius: 10px;}
    ::-webkit-scrollbar-thumb { background: #282841; border-radius: 10px;}
  </style>
</head>
<body>
  <header>
    <span class="premium-badge" aria-label="Premium">✨ PREMIUM</span>
    <div class="tile-brand" aria-label="HYBRID MASTER 51 branding">
      <svg fill="none" viewBox="0 0 50 50"
        aria-hidden="true"><circle cx="25" cy="25" r="24" fill="#161523"/><path d="M13,39 Q20,41 25,26 Q30,41 37,39 L25,11z"
        fill="#FFD700" stroke="#13E884" stroke-width="2"/></svg>
      <span>HYBRID MASTER 51 <span class="gradient-text">• App</span></span>
    </div>
    <p class="header-desc">Programme premium et tracking dynamique inspirés de Hevy, iOS 18, Linear. Suivi, statistiques, rapport, onboarding flash et expérience 100% mobile/desktop, tout-en-un.<br>
      <span style="color: #FFD700;">20€/mois</span> <span aria-label="premium lock" style="margin-left:2px;">🔒</span></p>
  </header>

  <main tabindex="0">
    <!-- Onboarding -->
    <section id="onboarding" aria-label="Introduction au programme" tabindex="0">
      <h2 class="section-title">Bienvenue&nbsp;!</h2>
      <div>
        <p>
          Ce coach digital vous propose un suivi musculation ultra-haut de gamme et 100% personnalisé sur le programme HYBRID MASTER 51.<br>
          <b>Accès :</b> Programme complet, mapping muscles, progression, séries, statistiques, rapports, tests unitaires et export – tout local, 0 cloud.
        </p>
        <ul>
          <li>Navigation fluide (mobile ou desktop)</li>
          <li>Sauvegarde automatique locale</li>
          <li>Rapport Markdown, CSV, impression, export/import</li>
          <li>Onboarding express, feedback visuel/sonore premium</li>
        </ul>
        <button class="button gold" id="onboarding-finish-btn" aria-label="Démarrer l'app">Démarrer →</button>
      </div>
    </section>

    <!-- Programme Info / Edit / Journal / Tracker -->
    <section id="prog-main" hidden aria-label="Suivi HYBRID MASTER 51">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span class="section-title" aria-label="Planning de la semaine">Semaine & Séance</span>
        <button class="icon-btn" id="info-btn" aria-label="Infos sur le programme">
          <svg viewBox="0 0 24 24" width="24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="#FFD700" stroke-width="2" fill="none"/>
            <text x="50%" y="65%" font-size="12" fill="#FFD700" text-anchor="middle" font-family="Inter">i</text>
          </svg>
        </button>
      </div>
      <div class="week-day-selector" id="week-list" aria-label="Sélecteur de semaine" role="tablist"></div>
      <div class="day-selector" id="day-list" aria-label="Sélecteur de jour" role="tablist"></div>
      <div id="block-container"></div>
    </section>

    <!-- Timer Bloc -->
    <section id="timer-section" hidden aria-label="Timer de repos" style="padding:7px 8px 15px 8px;min-height:70px;">
      <div class="timer-block">
        <div class="timer-value" id="timer-value" aria-label="Temps restant">00:00</div>
        <button class="button secondary" id="timer-start-btn" aria-label="Démarrer le timer">Démarrer</button>
        <button class="button secondary" id="timer-stop-btn" aria-label="Arrêter le timer">Stop</button>
        <button class="button danger" id="timer-reset-btn" aria-label="Réinitialiser le timer">Reset</button>
      </div>
      <div id="timer-feedback" class="feedback"></div>
    </section>

    <!-- Statistiques + Graphiques -->
    <section id="stats-section" hidden aria-label="Statistiques et graphiques de progression">
      <div class="section-title">Statistiques</div>
      <div class="stat-cards" id="stat-cards"></div>
      <div class="charts-container">
        <div class="chart-block">
          <canvas id="chart-progress-load" width="360" height="180" aria-label="Progression des charges"></canvas>
        </div>
        <div class="chart-block">
          <canvas id="chart-muscle-vol" width="360" height="180" aria-label="Volume par muscle"></canvas>
        </div>
        <div class="chart-block">
          <canvas id="chart-completion" width="360" height="115" aria-label="Taux de complétion"></canvas>
        </div>
      </div>
    </section>

    <!-- Journal Execution tests/aborts -->
    <section id="journal-section" hidden aria-label="Journal d’exécution/tests">
      <div class="section-title">Journal &amp; Tests</div>
      <div class="journal" id="journal-exec" tabindex="0" aria-label="Historique/journal d’exécution"></div>
      <button class="button success" id="run-tests-btn" aria-label="Exécuter les tests unitaires">Tests unitaires</button>
      <button class="button danger" id="reset-data-btn" aria-label="Réinitialisation complète">Reset data</button>
      <button class="button secondary" id="abort-btn" aria-label="Annuler l’action en cours">Abort</button>
      <button class="button secondary" id="export-btn" aria-label="Exporter (CSV/JSON)">Export CSV/JSON</button>
      <input type="file" id="import-drive" accept=".json,.csv,.txt" hidden tabindex="-1" aria-label="Importer données"/>
      <button class="button secondary" id="import-btn" aria-label="Importer">Importer</button>
      <div id="tests-feedback" class="feedback"></div>
    </section>

    <!-- Rapport Markdown -->
    <section id="report-section" hidden aria-label="Rapport Markdown exportable">
      <div class="section-title">Rapport exportable</div>
      <textarea class="markdown-report-area" id="markdown-report" readonly spellcheck="false" aria-label="Zone rapport Markdown"></textarea>
      <div style="display:flex;gap:8px;">
        <button class="button secondary" id="copy-md-btn" aria-label="Copier Markdown">Copier</button>
        <button class="button secondary" id="print-md-btn" aria-label="Imprimer/PDF">Imprimer/PDF</button>
      </div>
    </section>

    <!-- Infos modal -->
    <div id="modal-info" class="focus-modal-bg hidden" role="dialog" aria-modal="true">
      <div class="focus-modal">
        <div style="font-size:21px;font-weight:700;margin-bottom:16px;">Programme complet : HYBRID MASTER 51</div>
        <div style="max-height:45vh;overflow:auto;text-align:left;" id="modal-prog-txt"></div>
        <div class="modal-btns">
          <button class="button gold" id="modal-close-btn" aria-label="Fermer">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Confirm reset modal -->
    <div id="modal-confirm-reset" class="focus-modal-bg hidden" role="dialog" aria-modal="true">
      <div class="focus-modal">
        <div style="font-size:19px;font-weight:800;margin-bottom:14px;">⚠️ Confirmation requise</div>
        <p>Êtes-vous sûr(e) de vouloir RÉINITIALISER toutes vos données (tracking, stats, rapports, config)&nbsp;?<br>
        <b>Action irréversible.</b></p>
        <div class="modal-btns">
          <button class="button danger" id="confirm-reset-btn" aria-label="Confirmer suppression">Oui, reset</button>
          <button class="button secondary" id="cancel-reset-btn" aria-label="Annuler suppression">Non, annuler</button>
        </div>
      </div>
    </div>
  </main>

  <!-- === FINISHER === -->
  <div style="font-size:13.4px;color:#CCC;text-align:center;margin:13px 0 4px 0;padding:0 0 32px 0;">
    Design inspiré de Hevy / iOS 18.<br>
    Tests exécutés : <span aria-label="Statut tests" id="tests-run-stat">non</span>. 7/7 unit tests passés : <span id="unit-tests-stat">non</span>. runFullVerification passé : <span id="full-verif-stat">non</span>.
  </div>
  <audio id="beep-ok" src="https://cdn.pixabay.com/audio/2022/08/20/audio_12c30383c6.mp3" preload="auto"></audio>
  <audio id="beep-warn" src="https://cdn.pixabay.com/audio/2022/03/15/audio_114bcc9c9f.mp3" preload="auto"></audio>
  <script>
    // ==== CONST PROGRAMME : HYBRID MASTER 51 - voir prompt joint ====
    // Tout le texte et mapping détaillé du programme, mapping, progression, deload etc :
    const PROMPT_IA_TXT = `
# HYBRID MASTER 51 – Programme complet

SPLIT 6J / 2 blocs alternants, rotation technique, mapping muscles corrigé direct/indirect, progression Option 2 (Arrivée S26 forcée).
Blocs :
BLOC A : Pecs/Dos/Biceps / Quadriceps / Core
BLOC B : Epaules/Jambes post. / Triceps / Dos / Core

Progression :
- 26 semaines : S1→S26 : +2,5kg au lift principal chaque semaine SAUF pendant deload (aucun incrément pendant deloads ; forcer arrivé S26).
- Deload : 1 semaine sur 4 (S4, S8, S12...), baisse 40% charges, volume -30%, aucune progression.

Mapping muscles (corrigé) :
- Direct : Pectoraux, Dos, Biceps, Triceps, Jambes, Epaules, Core
- Indirect : Avant-bras, Trapèzes, Fessiers, Adducteurs
- Blocs: chaque exo taggé direct/indirect

Semaine / Jour :
- S1–S26 : rotation bloc, 6 jours/s, Blocs A/B alternés chaque semaine.
- Rotation technique biceps 1/2.

Bloc A :
1. Développé couché (Pecs, triceps, direct)
2. Tractions supi prise large (Dos, biceps, direct)
3. Curl haltères/bb (Biceps, avant-bras, direct)
4. Front squat (Quadriceps, fessiers, direct)
5. Planche lestée (Core, direct)

Bloc B :
1. DMH (Epaules, triceps, direct)
2. SDT jambes tendues (Jambes post., fessiers, direct)
3. Dips (Triceps, pectoraux, direct)
4. Rowing menton (Dos, trapèzes, indirect)
5. Ab wheel (Core, direct)

Checklist/Validation :
- Respect split/rotation/semaine/deloads.
- Progression charges (option 2), pas pendant deloads, forcer S26.
- Tracking par série (poids, reps, RPE, notes max 1000c), validation entrée, stats muscles map direct/indirect.
- Rapport markdown exact blocs/résultats/volume.
- Unit tests et runFullVerification.

Exemple d’une semaine :
S3J1 (Bloc A) : Développé couché, tractions, curl, front squat, planche
S3J4 (Bloc B) : DMH, SDT jambes tendues, dips, rowing menton, ab wheel

Techniques rotation : Biceps (curl incliné/barre alterne 1/2), abdos (planche/ab wheel alterne Bloc A/B).

-- FIN PROGRAMME --
`.trim();

    // ---- CONSTANTES ----
    const NB_SEMAINES = 26;
    const NB_JOURS_SEMAINE = 6;
    const NB_BLOCS = 2;
    const DEL_LOADS_WEEKS = Array.from({length: Math.floor(NB_SEMAINES/4)}, (_,i) => (i+1)*4);
    const WEEK_LABELS = Array.from({length: NB_SEMAINES}, (_,i) => `S${i+1}`);
    const DAY_LABELS = ['Jour 1','Jour 2','Jour 3','Jour 4','Jour 5','Jour 6'];
    // mapping muscles
    const MUSCLES_DIRECT = [
      'Pectoraux','Dos','Biceps','Triceps','Jambes','Epaules','Core'
    ];
    const MUSCLES_INDIRECT = [
      'Avant-bras','Trapèzes','Fessiers','Adducteurs'
    ];

    // STRUCTURE BLOC EXOS
    const BLOCS = [
      {
        id: 'A',
        nom: 'Bloc A',
        exercices: [
          {id:'dev_couché',label:'Développé couché',m_direct:['Pectoraux','Triceps'],m_indirect:[],tech:false,notes:'',baseLoad:60},
          {id:'trs_supi',label:'Tractions supi prise large',m_direct:['Dos','Biceps'],m_indirect:[],tech:false,notes:'',baseLoad:0},
          {id:'curl',label:'Curl haltères/barre',m_direct:['Biceps'],m_indirect:['Avant-bras'],tech:true,notes:'Alt. incliné/barre',baseLoad:12},
          {id:'front_squat',label:'Front squat',m_direct:['Jambes'],m_indirect:['Fessiers','Adducteurs'],tech:false,notes:'',baseLoad:45},
          {id:'planche',label:'Planche lestée',m_direct:['Core'],m_indirect:[],tech:true,notes:'Tech. Bloc A',baseLoad:17}
        ]
      },
      {
        id: 'B',
        nom: 'Bloc B',
        exercices: [
          {id:'dmh',label:'DMH – Développé militaire haltères',m_direct:['Epaules','Triceps'],m_indirect:[],tech:false,notes:'',baseLoad:16},
          {id:'sdt_jt',label:'SDT jambes tendues',m_direct:['Jambes'],m_indirect:['Fessiers'],tech:false,notes:'',baseLoad:60},
          {id:'dips',label:'Dips',m_direct:['Triceps','Pectoraux'],m_indirect:[],tech:false,notes:'',baseLoad:0},
          {id:'rowing_menton',label:'Rowing menton',m_direct:['Dos'],m_indirect:['Trapèzes'],tech:false,notes:'',baseLoad:30},
          {id:'ab_wheel',label:'Ab wheel',m_direct:['Core'],m_indirect:[],tech:true,notes:'Tech. Bloc B',baseLoad:0}
        ]
      }
    ];

    // ROTATION biceps/techniques
    function exercice_label_rotatif(exo, blocId, week){
      if (exo.id==='curl'){
        return week%2===0?'Curl barre':'Curl incliné';
      }
      if (exo.id==='planche' && blocId==='A'){
        return 'Planche lestée';
      }
      if (exo.id==='ab_wheel' && blocId==='B'){
        return 'Ab wheel';
      }
      return exo.label;
    }

    // Progression option 2: forcer arrivée S26, aucun incrément pendant deload, +2.5kg/sem sur exos pertinents (main strength exos)
    // Liste des lifts progressifs
    const LIFTS_PROGRESSIFS = [
      'dev_couché','front_squat','dmh','sdt_jt','rowing_menton'
    ];

    // ---- State et utils persistants ----
    let currentWeek = 0, currentDay = 0, timerID = null, timerRestSec = 90, timerRunning = false;
    let allData = {}; // Format: { SemaineJour: { exos: {exo1: [{poids,reps,rpe,note}], exo2:[...], ...}, timestamp... } }
    let journalExec = [];
    let runTestsResults = {};
    let snapshotBeforeTests = null;

    // LocalStorage : {allData, journalExec}
    const STORAGE_KEY = 'hybridmaster51_data_v2';

    // ==== INIT APP : onboarding, données
    function saveAllData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        allData, journalExec
      }));
    }
    // sauvegarde instantanée à tout changement
    function onDataChanged(){
      saveAllData();
      updateStats();
      updateCharts();
      makeAndDisplayMarkdown();
    }
    function loadAllData(){
      let d = localStorage.getItem(STORAGE_KEY);
      if(d) try {
        const parsed = JSON.parse(d);
        if(parsed.allData) allData=parsed.allData;
        if(parsed.journalExec) journalExec=parsed.journalExec;
      } catch(e){ allData={}; journalExec=[]; }
    }
    // Reset: snapshot before
    function resetData(confirmed){
      if(!confirmed){
        showModal('confirm-reset');
        return;
      }
      localStorage.removeItem(STORAGE_KEY);
      allData={};
      journalExec=[];
      updateJournal('Réinitialisation totale des données utilisateur.',true);
      location.reload();
    }
    // Snapshot
    function snapshotData(){
      return JSON.stringify({allData,journalExec});
    }
    function restoreDataFromSnapshot(snap){
      try{
        let o=JSON.parse(snap);
        if(o.allData && o.journalExec){
          allData=o.allData; journalExec=o.journalExec;
          saveAllData();
          updateJournal("Snapshot restauration OK.");
          updateStats(); makeAndDisplayMarkdown(); updateCharts();
        }
      }catch{}
    }
    // Import/export CSV/JSON
    function exportDataFile(type){
      let blob,fn;
      if(type==='csv'){
        let rows = [ "Semaine;Jour;Exercice;Poids;Reps;RPE;Notes" ];
        Object.entries(allData).forEach(([key,val])=>{
          let [sW,sJ]=key.split('-').map(Number);
          Object.entries(val.exos).forEach(([idx,series])=>{
            series.forEach(serie=>{
              rows.push([sW+1,sJ+1,idx,serie.poids,serie.reps,serie.rpe,serie.note||''].join(';'));
            });
          });
        });
        blob = new Blob([rows.join('\n')],{type:"text/csv"});
        fn = 'hybridmaster51.csv';
      } else {
        let content = JSON.stringify({allData,journalExec},null,2);
        blob = new Blob([content],{type: "application/json"});
        fn = 'hybridmaster51.json';
      }
      let l=document.createElement('a');
      l.href=URL.createObjectURL(blob);
      l.download=fn;
      l.click();
      updateJournal("Export "+type.toUpperCase()+" terminé.");
    }
    function importFileChoose(){
      document.getElementById('import-drive').value = '';
      document.getElementById('import-drive').click();
    }
    function handleFileImport(evt){
      const f=evt.target.files[0];
      if(!f) return;
      const rdr = new FileReader();
      rdr.onload = function(e){
        if(f.name.endsWith('.json')){
          try{
            let obj = JSON.parse(e.target.result);
            if(obj.allData && obj.journalExec!==undefined){
              allData = obj.allData;
              journalExec = obj.journalExec;
              saveAllData();
              updateJournal("Import JSON réussi !");
              location.reload();
              return;
            }
          }catch{}
        } else if(f.name.endsWith('.csv')) {
          let text = e.target.result, lines = text.split('\n');
          let h = lines.shift().split(';');
          let mapIdx = {}; h.forEach((v,i)=>mapIdx[v.trim().toLowerCase()] = i);
          lines.forEach(line=>{
            if(line.trim().length<3)return;
            let cols = line.split(';');
            let s = parseInt(cols[mapIdx['semaine']])-1, d = parseInt(cols[mapIdx['jour']])-1, n=cols[mapIdx['exercice']];
            if(!allData[`${s}-${d}`]) allData[`${s}-${d}`]={exos:{}};
            if(!allData[`${s}-${d}`].exos[n])allData[`${s}-${d}`].exos[n]=[];
            allData[`${s}-${d}`].exos[n].push({
              poids:parseFloat(cols[mapIdx['poids']]),reps:parseInt(cols[mapIdx['reps']]),rpe:parseFloat(cols[mapIdx['rpe']]),note:(cols[mapIdx['notes']]||'')
            });
          });saveAllData(); updateJournal("Import CSV terminé (rechargement)...");location.reload();
          return;
        }
        updateJournal("Erreur import (format).",true);
      };
      rdr.readAsText(f);
    }

    // ---- UI ELEMENTS/HELPERS ----
    function $(id){return document.getElementById(id);}
    function showSection(id){
      ['onboarding','prog-main','timer-section','stats-section','journal-section','report-section'].forEach(s=>$(s).hidden=(s!==id));
    }
    // Modal helpers (info/modal)
    function showModal(id){
      if(id==='info'){
        $('modal-prog-txt').innerText=PROMPT_IA_TXT;
        $('modal-info').classList.remove('hidden');
      } else if(id==='confirm-reset'){
        $('modal-confirm-reset').classList.remove('hidden');
      }
    }
    function closeModals(){
      $('modal-info').classList.add('hidden');$('modal-confirm-reset').classList.add('hidden');
    }

    // Week/Day navigation
    function makeWeekDaySelectors(){
      let wl = $('week-list'), dl = $('day-list');
      wl.innerHTML = '';
      for(let w=0;w<NB_SEMAINES;++w){
        let b = document.createElement('button');
        b.className='week-btn'+(currentWeek===w?' selected':'');
        b.textContent = WEEK_LABELS[w]+(DEL_LOADS_WEEKS.includes(w+1)?' • deload':'');
        b.setAttribute('tabindex',0);
        b.setAttribute('aria-label', 'Semaine '+(w+1)+(DEL_LOADS_WEEKS.includes(w+1)?' deload':''));
        if(DEL_LOADS_WEEKS.includes(w+1)) b.style.background='var(--gold)';
        b.onclick = ()=>{currentWeek=w;makeWeekDaySelectors(); updateExerciseBlock();};
        wl.appendChild(b);
      }
      dl.innerHTML='';
      for(let d=0;d<NB_JOURS_SEMAINE;++d){
        let b=document.createElement('button');
        b.className='day-btn'+(currentDay===d?' selected':'');
        b.textContent=DAY_LABELS[d];
        b.setAttribute('tabindex',0);
        b.setAttribute('aria-label','Jour '+(d+1));
        b.onclick=()=>{currentDay=d;makeWeekDaySelectors();updateExerciseBlock();};
        dl.appendChild(b);
      }
    }

    // Calcul bloc actuel pour semaine/jour
    function blocForWeekDay(week,day){
      // Bloc A: S1 impairs, Bloc B: S2 pairs, alternance chaque semaine
      const blocId = ((week%2)===0)?'A':'B';
      return (day%2===0) ? blocId : (blocId==='A'?'B':'A');
    }
    function getBlocObj(blocId){return BLOCS.find(b=>b.id===blocId);}
    // Affichage bloc/exercices tracker pour la semaine/jour
    function updateExerciseBlock(){
      let blocId = blocForWeekDay(currentWeek,currentDay);
      let bloc = getBlocObj(blocId);
      let deload = DEL_LOADS_WEEKS.includes(currentWeek+1);
      let cont = $('block-container');
      cont.innerHTML='';
      let t = document.createElement('div');
      t.className = 'block-title'+(deload?" deload":'');
      t.innerText = bloc.nom+(deload?"  (deload – charges -40%)":'');
      cont.appendChild(t);

      bloc.exercices.forEach((exo,ei)=>{
        const exoLabel = exercice_label_rotatif(exo, blocId, currentWeek);
        let wrap=document.createElement('div');
        wrap.className = 'series-row'+(deload?' deload':'')+(exo.tech?' block-technical':'');
        wrap.tabIndex=0; wrap.setAttribute('aria-label', exo.label);

        if(exo.tech)wrap.className+=' block-technical';
        let lbl = document.createElement('span');
        lbl.innerHTML = (ei+1)+". "+exoLabel+" <span style='font-size:15px;color:#FFD700;opacity:0.86;'>" + (exo.notes||'')+"</span>";
        lbl.style.flex="3";
        wrap.appendChild(lbl);

        // Find tracked séries : clé de tracking : semaine-jour
        let k = currentWeek+'-'+currentDay;
        let trackedSeries = ((allData[k]||{}).exos||{})[exo.id]||[];
        // nombre de séries à afficher (remplir 4 pour force UX)
        let nbSeries = Math.max(4,trackedSeries.length||0);
        let seriesContainer = document.createElement('div');
        seriesContainer.className='series-list';
        for(let s=0;s<nbSeries;++s){
          let row = document.createElement('div');
          row.style.display='flex'; row.style.gap='2px'; row.style.alignItems='center';

          // Champs inputs :
          row.innerHTML = `<span style="color:var(--gold);font-weight:700;width:20px;">${s+1}</span>`;
          let inpP = document.createElement('input');inpP.type='number';inpP.min='0.2';inpP.step='0.5';inpP.placeholder='Poids (kg)';inpP.ariaLabel='Poids (kg)';inpP.tabIndex=0;inpP.required=true;inpP.autocomplete="off";
          let inpR = document.createElement('input');inpR.type='number';inpR.min=1;inpR.max=50;inpR.placeholder='Rep.';inpR.ariaLabel='Réps';inpR.tabIndex=0;inpR.required=true;inpR.autocomplete="off";
          let inpS = document.createElement('input');inpS.type='number';inpS.min=1;inpS.max=10;inpS.placeholder='RPE';inpS.ariaLabel='RPE';inpS.tabIndex=0;inpS.required=true;inpS.autocomplete="off";
          let inpN = document.createElement('input');inpN.type='text';inpN.maxLength=1000;inpN.placeholder='Note ?';inpN.ariaLabel='Note';inpN.tabIndex=0;

          // Préremplissage si suivi
          if(trackedSeries[s]){
            inpP.value=trackedSeries[s].poids||'';
            inpR.value=trackedSeries[s].reps||'';
            inpS.value=trackedSeries[s].rpe||'';
            inpN.value=trackedSeries[s].note||'';
            row.className += ' completed';
          }
          row.appendChild(inpP);row.appendChild(inpR);row.appendChild(inpS);row.appendChild(inpN);

          // Save auto
          function saveSerieForm() {
            let vP=Number(inpP.value)||0;
            let vR=Number(inpR.value)||0;
            let vS=Number(inpS.value)||0;
            let vN=inpN.value||'';
            if(vP<=0||vR<1||vR>50||vS<1||vS>10||vN.length>1000){
              row.classList.add('danger'); return;
            }
            row.classList.remove('danger');
            if(!allData[k]) allData[k]={exos:{}};
            if(!allData[k].exos[exo.id]) allData[k].exos[exo.id]=[];
            allData[k].exos[exo.id][s]={poids:vP,reps:vR,rpe:vS,note:vN};
            updateJournal(`[Suivi] ${WEEK_LABELS[currentWeek]} ${DAY_LABELS[currentDay]} – ${exoLabel} Série ${s+1}: ${vP}kg x${vR}, RPE ${vS}`);
            onDataChanged();
            playOK();
          }
          // Save on blur / change
          [inpP,inpR,inpS,inpN].forEach(inp=>inp.onchange=inp.onblur=saveSerieForm);

          // bouton suppression
          let delBtn = document.createElement('button');
          delBtn.className='icon-btn';delBtn.innerHTML='🗑️';delBtn.title='Effacer';
          delBtn.onclick = ()=>{
            if(allData[k]&&allData[k].exos[exo.id]){
              allData[k].exos[exo.id].splice(s,1);
              if(allData[k].exos[

Sources
